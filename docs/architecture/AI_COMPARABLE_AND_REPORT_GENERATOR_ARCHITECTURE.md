# AI Comparable Engine + AI Appraisal Report Generator (Israel)\n\n## 1) High-level production architecture\n\n```mermaid\nflowchart LR\n  A[Data Sources\n  - data.gov.il transactions\n  - listings\n  - GIS / zoning\n  - macro indicators\n  - permits/contracts/tabu\n  - photos] --> B[Ingestion Gateway]\n\n  B --> C1[Address Normalization Service\n  Hebrew cleanup + canonical IDs]\n  B --> C2[Geocoding + Spatial Enrichment]\n  B --> C3[Dedup + Entity Resolution]\n  B --> C4[Document Parsing / OCR]\n  B --> C5[Image Analysis]\n\n  C1 --> D[(PostgreSQL + PostGIS)]\n  C2 --> D\n  C3 --> D\n  C4 --> D\n  C5 --> D\n\n  D --> E[(Vector DB / pgvector)]\n\n  D --> F[Comparable Search Service\n  KNN + rules + explainability]\n  E --> F\n\n  F --> G[Adjustment Service\n  rules + ML residual]\n  G --> H[Valuation Service\n  outliers + range + confidence]\n\n  D --> I[Report Orchestrator\n  grounding + templates + validation]\n  H --> I\n  C4 --> I\n  C5 --> I\n\n  I --> J[PDF/Export Service\n  court-ready + signature + versions]\n\n  F --> K[REST/GraphQL API Gateway]\n  I --> K\n  K --> L[Web/Mobile UI\n  sliders + one-click + offline mode]\n\n  H --> M[(Audit Log / Event Store)]\n  I --> M\n```\n\n### SLA targets\n- Comparable search p95 < 2s\n- Report draft p95 < 8s (with cached document/image embeddings)\n- Horizontal scale to millions of properties via partitioned tables + ANN indexes\n\n---\n\n## 2) Data model summary\n\nSee SQL file: [backend/sql/ai_appraisal_schema.sql](../../backend/sql/ai_appraisal_schema.sql).\n\nKey entities:\n- `properties`, `transactions`, `listings`, `planning_entities`, `macro_indicators`\n- `property_vectors` (vector embedding for KNN)\n- `comparable_runs`, `comparable_candidates`, `adjustment_overrides`\n- `documents`, `document_facts`, `images`, `image_findings`\n- `reports`, `report_sections`, `report_versions`, `audit_events`\n\n---\n\n## 3) API design\n\nOpenAPI spec: [backend/openapi/ai-appraisal-api.yaml](../../backend/openapi/ai-appraisal-api.yaml)\n\nMain endpoints:\n- `POST /api/v1/comparables/search`\n- `POST /api/v1/comparables/{runId}/adjustments/override`\n- `POST /api/v1/valuations/estimate`\n- `POST /api/v1/reports/generate`\n- `POST /api/v1/reports/{reportId}/validate`\n- `POST /api/v1/reports/{reportId}/finalize`\n\nGraphQL (optional):\n- Query `comparableRun(id)`\n- Mutation `runComparableSearch(subjectId, topK)`\n- Mutation `overrideAdjustment(...)`\n- Mutation `generateReport(...)`\n\n---\n\n## 4) Similarity engine design\n\nImplemented reference module: [src/lib/aiComparableEngine.ts](../../src/lib/aiComparableEngine.ts)\n\nFeatures used in vector:\n- precise location (`lat`, `lng`)\n- property type\n- size, floor, building age\n- condition\n- elevator, parking, balcony, view\n- noise level\n- renovation state\n- planning potential\n\nAlgorithm:\n1. Normalize & validate input\n2. Build dense feature vector\n3. KNN via cosine similarity (ANN in production DB)\n4. Geo distance penalty + type mismatch penalty\n5. Return top-K with reason list per comparable\n\n---\n\n## 5) Adjustment model design\n\nImplemented reference module: [src/lib/aiComparableEngine.ts](../../src/lib/aiComparableEngine.ts)\n\nHybrid approach:\n- Rule-based factors (floor, elevator, renovation, balcony, parking, view, noise, size, planning potential)\n- ML residual correction (`MLAdjustmentWeights`) trained from historical closings\n- Hard caps for legal defensibility (e.g. Â±25% total adjustment per comp)\n\nManual overrides:\n- Every override creates `ManualOverrideEvent`\n- Persist to `adjustment_overrides` + `audit_events`\n\n---\n\n## 6) Valuation strategy\n\nImplemented reference module: [src/lib/aiComparableEngine.ts](../../src/lib/aiComparableEngine.ts)\n\nPipeline:\n1. Outlier removal (IQR)\n2. Strategy options:\n   - arithmetic mean\n   - weighted mean\n   - hedonic-like blended estimate\n3. Compute valuation **range** and confidence score\n\nConfidence factors:\n- comparable count\n- average similarity\n- recency\n- price dispersion\n\n---\n\n## 7) Explainability and court-readiness\n\nPer comparable:\n- Why selected (distance, type, area, floor, condition proximity)\n- Full adjustment breakdown\n- Final adjusted price\n\nPer report:\n- Fact-grounded section generation only\n- Source references per statement\n- Validation gate before finalization\n- Version history + digital signature\n\n---\n\n## 8) AI report generator design\n\nImplemented reference module: [src/lib/aiReportGenerator.ts](../../src/lib/aiReportGenerator.ts)\n\nCore layers:\n1. Grounded input object (`GroundedReportInput`)\n2. Prompt bundle builder with strict JSON schema\n3. Deterministic fallback draft generator\n4. Validation checks (numeric ordering, conflict facts, confidence caveats)\n\nNo-hallucination controls:\n- Grounded fact table injection\n- strict output schema\n- explicit missing-data policy\n- mandatory appraiser approval for finalization\n\n---\n\n## 9) Recommended tech stack\n\n- Backend: Node.js + TypeScript + Fastify/Express + BullMQ\n- DB: PostgreSQL 16 + PostGIS + pgvector\n- Stream: Kafka / Redpanda for ingestion events\n- OCR/Docs: Azure Document Intelligence / AWS Textract + custom rules\n- Vision: OpenAI vision-capable model / specialized defect model\n- LLM orchestration: prompt templates + policy layer + cache\n- Search: Postgres ANN + Redis cache\n- Auth/Security: OIDC, JWT, row-level access, KMS encryption\n- Observability: OpenTelemetry + Prometheus + Grafana + Sentry\n\n---\n\n## 10) Step-by-step roadmap\n\n### Phase 0 (2-3 weeks)\n- Finalize canonical schema and data contracts\n- Build ingestion skeleton + audit event bus\n- Stand up Postgres/PostGIS/pgvector in staging\n\n### Phase 1 (4-6 weeks)\n- Address normalization + dedupe + geocoding\n- Comparable vector generation + ANN indexes\n- `POST /comparables/search` API and explainability payload\n\n### Phase 2 (4-5 weeks)\n- Rule-based adjustment engine + override audit trail\n- Outlier filtering + valuation range service\n- UI sliders + instant recalculation\n\n### Phase 3 (4-6 weeks)\n- Document parsing and image analysis pipelines\n- Grounded report generation and validation gate\n- PDF export + versioning + digital signature\n\n### Phase 4 (3-4 weeks)\n- ML residual training pipeline + monitoring\n- Drift detection, recalibration, champion/challenger\n- Court/bank templates and UAT\n\n### Phase 5 (ongoing)\n- Production hardening: load tests, chaos tests, SOC2 controls\n- SLA tuning to keep comparable search p95 under 2s\n\n---\n\n## 11) Mobile/offline field mode\n\n- Local SQLite cache for active assignment\n- On-device photo metadata capture\n- Deferred sync with conflict resolution\n- Signed offline actions with replay-protected event IDs\n