# מערכת ניהול וניתוח נתוני שכירות

## סקירה כללית

מערכת מקיפה לניהול, ייבוא וניתוח נתוני שכירות עבור שמאי מקרקעין. המערכת מאפשרת לשמאים לנהל מאגר עסקאות שכירות, לבצע ניתוחים משוערים, ולהפיק המלצות מבוססות נתונים.

## מבנה המערכת

### 1. ניהול נתוני שכירות (`RentalDataManager`)

**מיקום:** `/src/components/RentalDataManager.tsx`

#### תכונות עיקריות:

##### א. ייבוא נתונים
- **ייבוא מקובץ CSV/Excel** - העלאת עסקאות שכירות מקבצים חיצוניים
- **יצירת נתוני דמו** - 100 עסקאות ריאליסטיות לצורך בדיקה והדגמה
- **מקורות נתונים חיצוניים** - תשתית להתחברות ל-API ממשלתיים (מצריך הרשאות)

##### ב. סינון וחיפוש
- חיפוש לפי כתובת
- סינון לפי עיר
- סינון לפי סוג נכס (דירה, בית, מסחרי, משרד)
- הצגת מספר העסקאות המסוננות

##### ג. סטטיסטיקות
- סה"כ עסקאות במערכת
- שכירות ממוצעת
- מחיר למ"ר ממוצע
- אחוז עסקאות מאומתות

##### ד. ייצוא
- ייצוא לקובץ CSV כולל כל הנתונים
- שמירת עסקאות עם תאריך

#### עמודות נדרשות לייבוא CSV:

```csv
כתובת,עיר,שכונה,רחוב,קומה,סוג נכס,חדרים,שטח,שכר דירה,תאריך שכירות,מרוהט,מעלית,חניה,מצב,מקור
```

**או בשמות אנגליים:**

```csv
address,city,neighborhood,street,floor,propertyType,rooms,area,monthlyRent,rentalDate,furnished,hasElevator,hasParking,condition,source
```

#### שדות נתונים:

| שדה | סוג | נדרש | הערות |
|-----|-----|------|-------|
| כתובת | טקסט | כן | כתובת מלאה |
| עיר | טקסט | כן | שם העיר |
| שכונה | טקסט | כן | שם השכונה |
| שטח | מספר | כן | שטח במ"ר |
| שכר דירה | מספר | כן | מחיר חודשי ב-₪ |
| תאריך שכירות | תאריך | כן | תאריך חתימת חוזה |
| חדרים | מספר | לא | מספר חדרים (יכול להכיל 0.5) |
| קומה | מספר | לא | מספר הקומה |
| סוג נכס | טקסט | לא | apartment/house/commercial/office |
| מצב | טקסט | לא | new/renovated/good/fair/poor |

---

### 2. ניתוח שכירות (`RentalAnalyzer`)

**מיקום:** `/src/components/RentalAnalyzer.tsx`

#### תכונות עיקריות:

##### א. הזנת נכס לשומה
טופס מקיף להזנת פרטי הנכס הנבדק:
- כתובת מלאה
- עיר ושכונה
- שטח (מ"ר)
- מספר חדרים
- קומה
- סוג נכס
- מצב (חדש, משופץ, טוב, בינוני, זקוק לשיפוץ)
- שנת בנייה
- מעלית (כן/לא)
- חניה (כן/לא)

##### ב. חישוב שכירות משוערת

המערכת מבצעת:
1. **סינון עסקאות רלוונטיות** - מחפשת עסקאות דומות לפי:
   - אותה עיר
   - אותו סוג נכס
   - טווח שטח דומה (±40%)
   - טווח חדרים דומה (±1 חדר)
   - עסקאות מ-6 החודשים האחרונים

2. **חישוב התאמות** - מתאים כל עסקה לפי:
   - **התאמת שטח** - עד 10% למ"ר
   - **התאמת קומה** - 1.5% לקומה
   - **התאמת גיל** - 0.3% לשנה
   - **התאמת מצב** - עד 15% לפי מצב
   - **התאמת מאפיינים** - חניה (5%), מעלית (3%)
   - **התאמת מיקום** - 5% לשכונה שונה
   - **התאמת זמן** - 0.5% לחודש

3. **חישוב דמיון** - מדרג כל עסקה לפי מידת הדמיון (0-100%)

4. **המלצת מחיר** - מחשב שכירות משוערת עם:
   - **טווח נמוך** - 95% מהמחיר המומלץ
   - **טווח מומלץ** - ממוצע משוקלל של 5 העסקאות הטובות ביותר
   - **טווח גבוה** - 105% מהמחיר המומלץ
   - **רמת ביטחון** - נמוכה/בינונית/גבוהה

##### ג. תוצאות מפורטות

**סטטיסטיקות שוק:**
- ממוצע שכירות
- חציון שכירות
- מינימום ומקסימום
- ממוצע למ"ר

**מגמת שוק:**
- כיוון השוק (עולה/יורד/יציב)
- אחוז שינוי ב-6 החודשים האחרונים

**טבלת עסקאות השוואה:**
- כתובת ומיקום
- פרטי הנכס (שטח, חדרים)
- שכירות מקורית
- התאמות שבוצעו (באחוזים)
- שכירות מותאמת
- מחיר למ"ר
- אחוז דמיון

**פירוט התאמות:**
- פירוט מלא של כל ההתאמות שבוצעו
- הסבר לכל סוג התאמה
- סיכום התאמה כוללת

---

## מנוע החישוב

### אלגוריתם חישוב שכירות משוערת

**קובץ:** `/src/lib/rentalEngine.ts`

#### שלב 1: סינון עסקאות רלוונטיות

```typescript
function filterRelevantTransactions(subject, transactions) {
  // סינון לפי:
  // 1. אותו סוג נכס
  // 2. אותה עיר
  // 3. עסקאות מ-6 חודשים אחרונים
  // 4. טווח שטח ±40%
  // 5. טווח חדרים ±1
}
```

#### שלב 2: חישוב התאמות

```typescript
function calculateAdjustments(subject, transaction) {
  adjustments = {
    area: (areaDiff / subject.area) * -10,
    floor: floorDiff * 1.5,
    age: ageDiff * 0.3,
    condition: conditionDiff * 3,
    features: featureScore, // parking +5%, elevator +3%
    location: neighborhoodDiff * -5,
    time: monthsAgo * 0.5,
    total: sum(all adjustments)
  }
  
  return adjustments
}
```

#### שלב 3: חישוב דמיון

```typescript
function calculateSimilarity(subject, transaction) {
  score = 100
  score -= areaDiff * 20
  score -= roomDiff * 5
  score -= floorDiff * 2
  score -= monthsAgo * 1.5
  
  if (sameNeighborhood) score += 10
  else score -= 15
  
  return min(100, max(0, score))
}
```

#### שלב 4: חישוב המלצה

```typescript
function calculateRecommendedRent(comparables, statistics, area) {
  // ממוצע משוקלל של 5 העסקאות הטובות ביותר
  topComps = comparables.slice(0, 5)
  
  weightedAverage = sum(comp.rent * comp.similarity) / sum(comp.similarity)
  
  return {
    low: weightedAverage * 0.95,
    mid: weightedAverage,
    high: weightedAverage * 1.05,
    confidence: calculateConfidence(comparables)
  }
}
```

---

## מקורות נתונים

### 1. ייבוא ידני (CSV/Excel)
- העלאת קבצים מהמחשב
- תמיכה בפורמט CSV ו-Excel
- בדיקת תקינות אוטומטית

### 2. נתוני דמו
- 100 עסקאות ריאליסטיות
- מערים שונות בישראל
- מחירי שכירות אמיתיים
- תאריכים מ-6 חודשים אחרונים

### 3. אינטגרציה אוטומטית למחשבוני שומה
המערכת משולבת ישירות במחשבונים הבאים לחישובי הכנסה אוטומטיים:

#### מחשבונים משולבים:
- **מחשבון שיטת ההיוון** - חישוב אוטומטי של הכנסות שכירות מהשוק
- **שווי דירות מגורים** - הערכת פוטנציאל שכירות לנכסי דיור
- **שווי משרדים** - אומדן הכנסות שכירות למשרדים מניבים
- **שווי נכסי מסחר** - חישוב פוטנציאל שכירות למסחר
- **שווי קרקעות** - הערכת ערך שכירות קרקע

#### תכונות האינטגרציה:
✅ **שליפה אוטומטית** - כפתור אחד לטעינת נתוני שוק
✅ **התאמה דינמית** - הנתונים מותאמים לפי סוג נכס, עיר, שטח וחדרים
✅ **רמת ביטחון** - הצגת רמת מהימנות הנתונים (נמוך/בינוני/גבוה)
✅ **טווחי מחיר** - הצגת טווח שכירות תחתון ועליון
✅ **מגמת שוק** - ניתוח מגמה (עולה/יציב/יורד) עם אחוזי שינוי
✅ **סטטיסטיקות מפורטות** - ממוצע, חציון, מינימום, מקסימום
✅ **מספר עסקאות** - כמות העסקאות שעליהן מבוסס הניתוח
✅ **מחיר למ"ר** - חישוב מחיר שכירות ממוצע למטר מרובע

#### איך זה עובד:
1. בכל מחשבון שומה משולב, יש קארד "אינטגרציה לנתוני שוק שכירות"
2. הזן פרטי נכס: עיר, סוג נכס, שטח, חדרים, שכונה (אופציונלי)
3. לחץ "שלוף נתוני שכירות מהשוק"
4. המערכת טוענת נתונים מנדל"ן + מקורות נוספים
5. התוצאות מוצגות עם כל הסטטיסטיקות
6. ההכנסות מועברות אוטומטית למחשבון השומה

### 4. API ממשלתיים (מצריך הרשאות)

המערכת כוללת תשתית להתחברות ל-API הבאים:

#### א. רשות המסים - נתוני שכירות
- **מה זה:** מאגר נתוני דיווחי שכירות לרשות המסים
- **נדרש:** מפתח API ממשרד האוצר
- **נתונים:** עסקאות שכירות מדווחות, כתובות, מחירים

#### ב. משרד הבינוי והשיכון
- **מה זה:** סטטיסטיקות מחירי שכירות ממשלתיות
- **נדרש:** מפתח API ממשרד הבינוי
- **נתונים:** מדדי שכירות, ממוצעים לפי אזורים

#### ג. מד"ב (מדינת ישראל - דירות ברשות)
- **מה זה:** עסקאות שכירות מאומתות
- **נדרש:** הרשאה ממשרד השיכון
- **נתונים:** עסקאות מאומתות, פרטי דיירים

**הערה חשובה:** חיבור למקורות אלו דורש:
1. רישום רשמי במשרד הממשלה הרלוונטי
2. קבלת מפתח API אישי
3. עמידה בדרישות אבטחת מידע וחוק הגנת הפרטיות

---

## שימוש במערכת

### תרחיש 1: ייבוא נתונים ראשוני

```
1. עבור ל"ניהול נתוני שכירות"
2. לחץ על טאב "ייבוא נתונים"
3. בחר באחד:
   - העלה קובץ CSV עם עסקאות קיימות
   - לחץ "צור נתוני דמו" ליצירת 100 עסקאות לדוגמא
4. בדוק את הנתונים בטאב "נתוני עסקאות"
```

### תרחיש 2: ניתוח שכירות לנכס חדש

```
1. עבור ל"ניתוח שכירות"
2. מלא את פרטי הנכס:
   - כתובת מלאה
   - עיר ושכונה
   - שטח ומספר חדרים
   - מאפיינים נוספים
3. לחץ "חשב שכירות משוערת"
4. בדוק את התוצאות:
   - שכירות מומלצת (טווח)
   - רמת ביטחון
   - עסקאות השוואה
   - פירוט התאמות
```

### תרחיש 3: ייצוא נתונים לניתוח חיצוני

```
1. עבור ל"ניהול נתוני שכירות"
2. השתמש בסינונים לבחירת עסקאות ספציפיות
3. לחץ "ייצוא CSV"
4. הקובץ יישמר עם תאריך נוכחי
5. פתח ב-Excel לניתוח נוסף
```

---

## נוסחאות ומתודולוגיה

### שיטת ההשוואה לשכירות

המערכת משתמשת בשיטת ההשוואה המותאמת, המבוססת על עקרונות שמאות מקרקעין:

**נוסחה בסיסית:**

```
שכירות משוערת = (Σ (שכירות מותאמת × משקל דמיון)) / Σ משקל דמיון
```

**שכירות מותאמת:**

```
שכירות מותאמת = שכירות מקורית × (1 + סה"כ התאמות / 100)
```

**משקל דמיון:**

```
משקל = אחוז דמיון / 100
```

### התאמות סטנדרטיות

| פרמטר | מקדם | הסבר |
|-------|------|------|
| שטח | -10% ל-10 מ"ר | ככל שהנכס גדול יותר, המחיר למ"ר נמוך יותר |
| קומה | 1.5% לקומה | קומות גבוהות יותר = מחיר גבוה יותר |
| גיל | 0.3% לשנה | נכסים חדשים יותר = מחיר גבוה יותר |
| מצב | עד 15% | חדש/משופץ מול זקוק לשיפוץ |
| חניה | ±5% | השפעה משמעותית על מחיר |
| מעלית | ±3% | רלוונטי בעיקר בקומות גבוהות |
| מיקום | -5% | שכונה שונה = פחות דמיון |
| זמן | 0.5% לחודש | התאמה למגמות שוק |

### רמות ביטחון

| רמה | תנאים | משמעות |
|-----|-------|---------|
| גבוהה | 5+ עסקאות, דמיון 80%+ | ניתן לסמוך על ההערכה |
| בינונית | 3+ עסקאות, דמיון 60%+ | הערכה סבירה, יש מקום לשיקול דעת |
| נמוכה | פחות מ-3 עסקאות או דמיון נמוך | יש להשתמש בזהירות, לחפש נתונים נוספים |

---

## טיפים מקצועיים

### 1. איכות נתונים
- **ודא דיוק** - בדוק כתובות ומחירים לפני ייבוא
- **עדכן באופן קבוע** - נתונים ישנים מעל 6 חודשים פחות רלוונטיים
- **אמת עסקאות** - סמן עסקאות מאומתות כאמינות יותר

### 2. ניתוח תוצאות
- **בדוק את רמת הביטחון** - אל תסתמך על ניתוח עם ביטחון נמוך
- **נתח את ההתאמות** - ודא שההתאמות הגיוניות
- **השווה לשוק** - בדוק שהתוצאה הגיונית ביחס לשוק הכללי

### 3. שימוש בטווחים
- **השתמש בטווח, לא במספר אחד** - המלץ תמיד על טווח שכירות
- **התאם לנסיבות** - שקול גורמים שהמערכת לא יכולה לדעת (נוף, רעש וכו')
- **הסבר ללקוח** - השתמש בפירוט ההתאמות כדי להסביר את השומה

### 4. ניהול מאגר
- **ארגון לפי ערים** - שמור נתונים נפרדים לערים שונות
- **ייבוא קבוע** - עדכן את המאגר בעסקאות חדשות
- **ניקוי תקופתי** - הסר עסקאות ישנות מאוד

---

## שאלות נפוצות

### ש: כמה עסקאות צריך כדי לקבל ניתוח אמין?
**ת:** לפחות 5 עסקאות דומות מ-6 החודשים האחרונים. ככל שיש יותר נתונים ברמת דמיון גבוהה, כך התוצאה אמינה יותר.

### ש: מה עושים אם אין מספיק עסקאות דומות?
**ת:** אפשר להרחיב את הקריטריונים:
1. להגדיל את טווח השטח
2. לכלול עסקאות משכונות סמוכות
3. להגדיל את טווח התאריכים ל-12 חודשים
4. לחפש נתונים נוספים ממקורות חיצוניים

### ש: האם המערכת מחליפה את שיקול הדעת השמאי?
**ת:** לא! המערכת היא כלי עזר לשמאי. השמאי חייב:
- לבדוק את התוצאות
- להתאים לפי ידע מקומי
- להוסיף שיקולים שהמערכת לא יודעת
- לקבל את ההחלטה הסופית

### ש: איך מוודאים שהנתונים מדויקים?
**ת:** 
1. ייבא רק מקורות מהימנים
2. סמן עסקאות מאומתות
3. בדוק חריגים (מחירים גבוהים/נמוכים מדי)
4. השווה לממוצעי שוק ידועים

### ש: מתי כדאי להשתמש בנתוני דמו?
**ת:** 
- להדגמה ללקוחות
- לבדיקת המערכת
- לאימון משתמשים חדשים
- **לא לשומות אמיתיות!**

---

## תמיכה טכנית

### בעיות נפוצות ופתרונות

**בעיה:** הייבוא נכשל
- בדוק שהקובץ בפורמט CSV
- ודא שיש עמודות נדרשות (כתובת, עיר, שטח, מחיר)
- בדוק encoding (UTF-8)

**בעיה:** לא נמצאו עסקאות דומות
- הרחב קריטריונים (שטח, תאריך)
- בדוק שהעיר נכתבה נכון
- ודא שיש מספיק נתונים במאגר

**בעיה:** רמת ביטחון נמוכה
- הוסף עסקאות נוספות
- חפש נתונים דומים יותר
- שקול מקורות נתונים נוספים

---

## עדכונים עתידיים (מתוכננים)

1. **אינטגרציה עם API ממשלתיים** - חיבור אוטומטי לנתונים רשמיים
2. **למידת מכונה** - שיפור דיוק ההתאמות לפי נתונים היסטוריים
3. **ניתוח טרנדים מתקדם** - חיזוי מגמות עתידיות
4. **ניתוח גיאוגרפי** - מפות אינטראקטיביות עם מחירי שכירות
5. **דוחות אוטומטיים** - יצירת דוחות שכירות מוכנים ללקוחות

---

## סיכום

מערכת ניהול וניתוח נתוני השכירות מספקת לשמאים:
- **מאגר מרכזי** לעסקאות שכירות
- **כלי חישוב מתקדם** לשכירות משוערת
- **שקיפות מלאה** בתהליך החישוב
- **תשתית מוכנה** להרחבות עתידיות

המערכת חוסכת זמן, משפרת דיוק ומספקת תמיכה מקצועית בתהליך השומה.
